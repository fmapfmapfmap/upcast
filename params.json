{"name":"Upcast","tagline":"operation declarative cloud ʕノ•ᴥ•ʔノ ︵ ┻━┻","body":"Upcast is a tool that provisions cloud infrastructure based on a declarative spec (*infra spec*)\r\nin [Nix](http://nixos.org/nix/) expression language.\r\nUpcast also includes a [opinionated base NixOS configuration](https://github.com/zalora/upcast/tree/master/nix/nixos)\r\nsuitable for cloud deployments.\r\nUpcast is inspired by NixOps.\r\n\r\n[![Build Status](https://travis-ci.org/zalora/upcast.svg?branch=master)](https://travis-ci.org/zalora/upcast)\r\n\r\n### Upcast tour\r\n\r\n```console\r\n% cabal install\r\n```\r\n\r\nContents of `infra.nix`:\r\n```nix\r\n{ lib ? import <upcast/lib> }:\r\nlet\r\n  ec2-args = {\r\n    accessKeyId = \"default\";\r\n    region = \"eu-west-1\";\r\n    zone = \"eu-west-1a\";\r\n    securityGroups = [ \"sg-bbbbbbbb\" ];\r\n    subnet = \"subnet-ffffffff\";\r\n    keyPair = \"my-keypair\";\r\n  };\r\n  instance = instanceType: ec2-args // { inherit instanceType; };\r\nin\r\n{\r\n  infra = {\r\n    ec2-instance = {\r\n      node1 = instance \"m3.large\";\r\n      node2 = instance \"m3.large\";\r\n    };\r\n  };\r\n\r\n  # you need <nixpkgs> in your $NIX_PATH to build this\r\n  # <upcast/nixos> is a drop-in replacement for <nixpkgs/nixos>\r\n  some-image = (import <upcast/nixos> {\r\n    configuration = { config, pkgs, lib, ... }: {\r\n      config.services.nginx.enable = true;\r\n    };\r\n  }).system;\r\n}\r\n```\r\n\r\n`upcast infra-tree` dumps the full json configuration of what's going to be provisioned,\r\nnote that upcast only evaluates the top level `infra` attribute.\r\n\r\n`upcast infra` actually provisions all resources and outputs the `ssh_config(5)` for all compute\r\nnodes in the spec.\r\n\r\n```console\r\n% upcast infra-tree infra.nix | jq -r .\r\n\r\n% upcast infra infra.nix > ssh_config\r\n```\r\n\r\n`upcast build-remote` and `upcast install` are wrappers over Nix/NixOS toolchain\r\nthat hugely [boost productivity](#achieving-productivity).\r\nHere they are used to build NixOS closures and install them on `node1`.\r\n\r\n```console\r\n% upcast build-remote -t hydra -A some-image infra.nix \\\r\n    | xargs -tn1 upcast install -c ssh_config -f hydra -t node1 \r\n```\r\n\r\nSame example without `build-remote`:\r\n\r\n```console\r\n% nix-build -I upcast=$(upcast nix-path) -A some-image -A some-image infra.nix\r\n% upcast install -c ssh_config -t node1 $(readlink ./result)\r\n```\r\n\r\nFor more examples see [nix-adhoc](https://github.com/proger/nix-adhoc) and upcast [tests](https://github.com/zalora/upcast/tree/master/test).\r\n\r\n### Goals\r\n\r\n- simplicity, extensibility;\r\n- shared state stored as nix expressions next to machines expressions;\r\n- first-class AWS support (including AWS features nixops doesn't have);\r\n- pleasant user experience and network performance (see below);\r\n- support for running day-to-day operations on infrastructure, services and machines.\r\n\r\n### Notable features\r\n\r\n- the infrastructure spec is evaluated separately from NixOS system closures\r\n  (installation must also be handled separately and is outside of `upcast` cli tool);\r\n- state is kept in a text file that you can commit into your VCS.\r\n- Upcast includes opinionated default NixOS configuration for\r\n  [EC2 instance-store instances](https://github.com/zalora/upcast/blob/master/nix/nixos/env-ec2.nix)\r\n  (see also the [list of AMIs](https://github.com/zalora/upcast/blob/master/nix/aws/ec2-amis.nix))\r\n  and [VirtualBox](https://github.com/zalora/upcast/blob/master/nix/nixos/env-virtualbox.nix).\r\n\r\n### Infrastructure services\r\n\r\n(this is what used to be called `resources` in NixOps)\r\n\r\n- New: EC2-VPC support, ELB support;\r\n- Additionally planned: AWS autoscaling, EBS snapshotting;\r\n- Different in EC2: CreateKeyPair (autogenerated private keys by amazon) is not supported, ImportKeyPair is used instead;\r\n- Not supported: sqs, s3, elastic ips, ssh tunnels, adhoc nixos deployments,\r\n                 deployments to expressions that span multiple AWS regions;\r\n- Most likely will not be supported: hetzner, auto-luks, auto-raid0, `/run/keys` support, static route53 support (like nixops);\r\n\r\n### Motivation\r\n\r\n![motivation](http://i.imgur.com/HY2Gtk5.png)\r\n\r\n\r\n### Achieving productivity\r\n\r\n\r\n> tl;dr: do all of these steps if you're using a Mac and/or like visiting Starbucks\r\n\r\n#### Remote builds\r\n\r\nUnlike [Nix distributed builds](http://nixos.org/nix/manual/#chap-distributed-builds)\r\npackages are not copied back and forth between the instance and your local machine.\r\n\r\n```bash\r\nupcast build-remote -t hydra.com -A something default.nix\r\n```\r\n\r\nIf you want to update your existing systems as part of your CI workflow, you can do something like this:\r\n\r\n```bash\r\nupcast infra examples/vpc-nix-instance.nix > ssh_config\r\n\r\nawk '/^Host/{print $2}' ssh_config | \\\r\n    xargs -I% -P4 -n1 -t ssh -F ssh_config % nix-collect-garbage -d\r\n\r\nawk '/^Host/{print $2}' ssh_config | \\\r\n    xargs -I% -P4 -n1 -t upcast install -t % $(upcast build-remote -A some-system blah.nix)\r\n```\r\n\r\n#### Nix-profile uploads\r\n\r\nRead more about Nix profiles [here](http://nixos.org/nix/manual/#sec-profiles).\r\n\r\nInstall a system closure to any NixOS system (i.e. update `system` profile) and switch to it:\r\n\r\n```bash\r\n# assuming the closure was built earlier\r\nupcast install -t ec2-55-99-44-111.eu-central-1.compute.amazonaws.com /nix/store/72q9sd9an61h0h1pa4ydz7qa1cdpf0mj-nixos-14.10pre-git\r\n```\r\n\r\nInstall a [buildEnv](https://github.com/NixOS/nixpkgs/blob/d232390d5dc3dcf912e76ea160aea62f049918e1/pkgs/build-support/buildenv/default.nix) package into `per-user/my-scripts` profile:\r\n\r\n```bash\r\nupcast build-remote -t hydra -A my-env default.nix | xargs -n1t upcast install -f hydra -p /nix/var/nix/profiles/per-user/my-scripts -t target-instance\r\n```\r\n\r\n#### Making instances download packages from a different host over ssh (a closure cache)\r\n\r\nIf you still want to (or have to) build most of the packages locally,\r\nthis is useful if one of your cache systems is accessible over ssh\r\nand has better latency to the instance than the machine you run Upcast on.  \r\n\r\nThe key to that host must be already available in your ssh-agent.\r\nInherently, you should also propagate ssh keys of your instances to\r\nthat ssh-agent in this case.\r\n\r\n```bash\r\nexport UPCAST_SSH_CLOSURE_CACHE=nix-ssh@hydra.com\r\n```\r\n\r\n#### SSH shared connections\r\n\r\n`ControlMaster` helps speed up subsequent ssh sessions by reusing a single TCP connection. See [ssh_config(5)](http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/ssh_config.5?query=ssh_config).\r\n\r\n```console\r\n% cat ~/.ssh/config\r\nHost *\r\n    ControlPath ~/.ssh/master-%r@%h:%p\r\n    ControlMaster auto\r\n    ControlPersist yes\r\n```\r\n\r\n### Known issues\r\n\r\n- state files are not garbage collected, have to be often cleaned up manually;\r\n- altering infra state is not supported properly (you need to remove using aws cli, cleanup the state file and try again);\r\n- word \"aterm\" is naming a completely different thing;\r\n\r\nNote: the app is currently in HEAVY development (and is already being used to power production cloud instances)\r\nso interfaces may break without notice.\r\n\r\n### More stuff\r\n\r\nThe AWS client code now lives in its own library: [zalora/aws-ec2](https://github.com/zalora/aws-ec2).\r\n","google":"UA-54327624-1","note":"Don't delete this file! It's used internally to help with page regeneration."}